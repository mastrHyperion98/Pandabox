import { Button } from "std-widgets.slint";
import { Palette, StandardTableView, ScrollView, StyleMetrics, LineEdit } from "std-widgets.slint";
import { ServiceForm, ServiceData } from "service-form.slint";

// Global state for the application's table data
export global AppData {
    in-out property <[[StandardListViewItem]]> table-rows: [];
    in-out property <string> toast-message: "";
    in-out property <bool> show-toast: false;
}

// View state management
export enum View {
    Form,  // Show the form view
    Table  // Show the table view
}

// Form operation mode
export enum FormMode {
    Add,   // Adding a new entry
    Edit   // Editing an existing entry
}

export component ServiceView {
    // Window dimensions
    min-width: 1280px;
    min-height: 720px;

    // Application state
    in-out property <View> show-state: View.Table;
    in-out property <bool> show-context-menu: false;
    in-out property <FormMode> form-mode: FormMode.Add;
    in-out property <ServiceData> current-service-data;
    property <int> current-row: -1;

    // Helper property to display form mode text
    property <string> form-mode-text: root.form-mode == FormMode.Add ? "Add" : "Edit";

    // Callbacks to Rust backend
    callback generate_password() -> string;
    callback save_service(ServiceData, string, int);
    callback delete_entry(string);
    callback copy_to_clipboard(string, string);

    // Toast notification
    if AppData.show-toast: Rectangle {
        width: 200px;
        height: 50px;
        x: (parent.width - self.width) / 2;
        y: parent.height - 100px;
        background: #2d2d2d;
        border-radius: 8px;
        drop-shadow-blur: 10px;
        drop-shadow-color: #00000080;

        HorizontalLayout {
            padding: 12px;
            alignment: center;
            
            Text {
                text: AppData.toast-message;
                color: #ffffff;
                font-size: 14px;
            }
        }

        // Auto-hide after 2 seconds
        animate opacity { duration: 300ms; }
    }

    // Context menu for right-click actions
    menu := ContextMenuArea {
        width: root.width;
        height: root.height;
        visible: root.show-context-menu;

        TouchArea {
        }

        Menu {
            MenuItem {
                title: "Copy Email";
                activated => {
                    root.show-context-menu = false;
                    root.copy_to_clipboard(root.current-service-data.email, "Email");
                    menu.close();
                }
            }
            MenuItem {
                title: "Copy Username";
                activated => {
                    root.show-context-menu = false;
                    root.copy_to_clipboard(root.current-service-data.username, "Username");
                    menu.close();
                }
            }
            MenuItem {
                title: "Copy Password";
                activated => {
                    root.show-context-menu = false;
                    root.copy_to_clipboard(root.current-service-data.id, "Password");
                    menu.close();
                }
            }
        }
    }

    if root.show-state == View.Table: VerticalLayout {
        padding: 25px;
        spacing: 50px;

        // Action buttons
        HorizontalLayout {
            spacing: 25px;

            // Add new entry button
            Button {
                text: "Add";
                primary: true;
                clicked => {
                    root.form-mode = FormMode.Add;
                    root.current-service-data = {};
                    root.show-state = View.Form;
                }
            }

            // Edit selected entry button
            Button {
                text: "Edit";
                enabled: root.current-row != -1;
                clicked => {
                    root.form-mode = FormMode.Edit;
                    root.show-state = View.Form;
                    root.current-row = -1;
                }
            }

            // Delete selected entry button
            Button {
                text: "Delete";
                enabled: root.current-row != -1;
                clicked => {
                    root.delete_entry(root.current-service-data.id);
                    root.current-row = -1;
                }
            }
        }

        // Copy toolbar - shown when a row is selected
        if root.current-row != -1: Rectangle {
            height: 60px;
            background: Palette.alternate-background;
            border-radius: 8px;
            drop-shadow-blur: 4px;
            drop-shadow-color: #00000020;

            HorizontalLayout {
                padding: 12px;
                spacing: 12px;
                alignment: center;

                Text {
                    text: "Quick Copy:";
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                // Copy Email button
                Rectangle {
                    width: 120px;
                    height: 36px;
                    background: email-touch.has-hover ? Palette.accent-background.darker(0.1) : Palette.accent-background;
                    border-radius: 6px;
                    
                    email-touch := TouchArea {
                        clicked => {
                            root.copy_to_clipboard(root.current-service-data.email, "Email");
                        }
                    }

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 6px;
                        alignment: center;

                        Text {
                            text: "ðŸ“§";
                            font-size: 16px;
                        }
                        Text {
                            text: "Email";
                            color: Palette.accent-foreground;
                            font-size: 13px;
                            font-weight: 500;
                        }
                    }
                }

                // Copy Username button
                Rectangle {
                    width: 140px;
                    height: 36px;
                    background: username-touch.has-hover ? Palette.accent-background.darker(0.1) : Palette.accent-background;
                    border-radius: 6px;
                    
                    username-touch := TouchArea {
                        clicked => {
                            root.copy_to_clipboard(root.current-service-data.username, "Username");
                        }
                    }

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 6px;
                        alignment: center;

                        Text {
                            text: "ðŸ‘¤";
                            font-size: 16px;
                        }
                        Text {
                            text: "Username";
                            color: Palette.accent-foreground;
                            font-size: 13px;
                            font-weight: 500;
                        }
                    }
                }

                // Copy Password button
                Rectangle {
                    width: 140px;
                    height: 36px;
                    background: password-touch.has-hover ? Palette.accent-background.darker(0.1) : Palette.accent-background;
                    border-radius: 6px;
                    
                    password-touch := TouchArea {
                        clicked => {
                            root.copy_to_clipboard(root.current-service-data.id, "Password");
                        }
                    }

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 6px;
                        alignment: center;

                        Text {
                            text: "ðŸ”‘";
                            font-size: 16px;
                        }
                        Text {
                            text: "Password";
                            color: Palette.accent-foreground;
                            font-size: 13px;
                            font-weight: 500;
                        }
                    }
                }
            }
        }

        // Main data table
        table := StandardTableView {
            columns: [
                { title: "ID", min_width: 25px },
                { title: "Application", min_width: 100px },
                { title: "Email", min_width: 100px },
                { title: "Username", min_width: 100px },
                { title: "Password", min_width: 100px },
                { title: "Description", min_width: 100px },
            ];
            rows: AppData.table-rows;

            // Handle row selection
            current-row-changed(current-row) => {
                root.current-row = current-row;
                root.current-service-data = {
                    id: AppData.table-rows[current-row][0].text,
                    service: AppData.table-rows[current-row][1].text,
                    email: AppData.table-rows[current-row][2].text,
                    username: AppData.table-rows[current-row][3].text,
                    password: "", // Not stored in memory
                    notes: AppData.table-rows[current-row][5].text,
                };
            }

            // Handle right-click context menu
            row-pointer-event(row_index, event, position) => {
                // First right-click on a row
                if (!root.show-context-menu && event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                    root.current-row = row_index;
                    root.show-context-menu = true;
                    menu.show({x:position.x, y: position.y + 75px});
                }
                // Right-click on another row while menu is open
                else if (root.show-context-menu && event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                    root.current-row = row_index;
                    menu.show({x:position.x, y: position.y + 75px});
                }
                // Click anywhere while menu is open
                else if (event.kind == PointerEventKind.down && root.show-context-menu) {
                    root.show-context-menu = false;
                    menu.close();
                }
            }
        }
    }


    // Form view for adding/editing entries
    if root.show-state == View.Form: Rectangle {
        width: parent.width;
        height: parent.height;

        ServiceForm {
            width: parent.width;
            height: parent.height;
            title: root.form-mode-text;
            service-data: root.current-service-data;
            service-name: root.current-service-data.service;
            email: root.current-service-data.email;
            username: root.current-service-data.username;
            password: root.current-service-data.password;
            confirm-password: root.current-service-data.password;
            notes: root.current-service-data.notes;

            save-pressed(data) => {
                root.save_service(data, root.form-mode-text, root.current-row);
                root.show-state = View.Table;
            }

            cancel-pressed() => {
                root.show-state = View.Table;
                root.current-service-data = {};
            }

            generate-password() => {
                self.password = generate_password();
                self.confirm-password = self.password;
            }
        }
    }
}