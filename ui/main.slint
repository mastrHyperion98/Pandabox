import { Button, Palette } from "std-widgets.slint";
import { AuthView } from "auth-view.slint";
import { ServiceView, AppData, FormMode} from "services-view.slint";
import { ServiceData } from "service-form.slint";
import "./fonts/C059-Roman.otf";

export enum Page {
    CreateDb,
    Authenticate,
    Passlock
}

export { AppData }

export component EntryWindow inherits Window {
    callback create_db_submitted(string);
    callback authenticate_submitted(string);
    callback generate_password()->string;
    callback save_service(ServiceData, string, int);
    callback delete_entry(string);
    callback copy_to_clipboard(string, string);
    callback save_all();
    callback import_csv();
    callback export_csv();

    title: "Pandabox";
    min-width: 1280px;
    min-height: 780px;
    full-screen: false;
    default-font-size: 16px;
    default-font-family: "C059";
    icon: @image-url("../resources/panda.png");
    in-out property <Page> current_page: Page.CreateDb;
    in-out property <bool> auth-error: false;
    in-out property <int> shake-trigger: 0;
    property <bool> show-file-menu: false;
    property <bool> show-help-menu: false;
    in-out property <string> app-version: "0.1.0";

    if current_page == Page.CreateDb: AuthView {
        button_text: "Create Database";
        placeholder_text: "Enter a strong master password";
        submitted(str) => { root.create_db_submitted(str) }
    }
    if current_page == Page.Authenticate: auth-view := AuthView {
        button_text: "Authenticate";
        placeholder_text: "Enter your master password";
        show-error <=> root.auth-error;
        shake-state: root.shake-trigger;
        submitted(str) => { root.authenticate_submitted(str) }
    }
    if current_page == Page.Passlock: Rectangle {
        
        VerticalLayout {
            spacing: 0px;
            
            // Menu Bar
            Rectangle {
                height: 32px;
                background: Palette.alternate-background;
                
                HorizontalLayout {
                    padding-left: 8px;
                    padding-right: 8px;
                    spacing: 0px;
                
                // File Menu
                file-menu-area := TouchArea {
                    width: 50px;
                    clicked => {
                        root.show-file-menu = !root.show-file-menu;
                        root.show-help-menu = false;
                    }
                    
                    Rectangle {
                        background: file-menu-area.has-hover || root.show-file-menu ? Palette.accent-background.darker(0.2) : transparent;
                        
                        Text {
                            text: "File";
                            vertical-alignment: center;
                            horizontal-alignment: center;
                            font-size: 13px;
                        }
                    }
                }
                
                // Help Menu
                help-menu-area := TouchArea {
                    width: 50px;
                    clicked => {
                        root.show-help-menu = !root.show-help-menu;
                        root.show-file-menu = false;
                    }
                    
                    Rectangle {
                        background: help-menu-area.has-hover || root.show-help-menu ? Palette.accent-background.darker(0.2) : transparent;
                        
                        Text {
                            text: "Help";
                            vertical-alignment: center;
                            horizontal-alignment: center;
                            font-size: 13px;
                        }
                    }
                }
                
                    Rectangle { } // Spacer
                }
            }
            
            // Main content
            service-view := ServiceView{
                app-version: root.app-version;
                generate_password() => { root.generate_password() }
                save_service(data, mode, row) => { root.save_service(data, mode, row) }
                delete_entry(id) => { root.delete_entry(id) }
                copy_to_clipboard(value, field_name) => { root.copy_to_clipboard(value, field_name) }
                save_all() => { root.save_all() }
                import_csv() => { root.import_csv() }
                export_csv() => { root.export_csv() }
            }
        }
        
        // File Menu Dropdown (positioned absolutely)
        if root.show-file-menu: Rectangle {
            x: 8px;
            y: 32px;
            width: 180px;
            z: 100;
            background: Palette.background;
            border-radius: 4px;
            drop-shadow-blur: 8px;
            drop-shadow-color: #00000040;
            
            VerticalLayout {
                padding: 4px;
                spacing: 2px;
                
                save-item := TouchArea {
                    height: 32px;
                    clicked => {
                        root.save_all();
                        root.show-file-menu = false;
                    }
                    
                    Rectangle {
                        background: save-item.has-hover ? Palette.accent-background.darker(0.1) : transparent;
                        border-radius: 2px;
                        
                        HorizontalLayout {
                            padding-left: 12px;
                            spacing: 8px;
                            
                            Text {
                                text: "üíæ";
                                vertical-alignment: center;
                            }
                            Text {
                                text: "Save All";
                                vertical-alignment: center;
                                font-size: 13px;
                            }
                        }
                    }
                }
                
                Rectangle { height: 1px; background: Palette.border; }
                
                import-item := TouchArea {
                    height: 32px;
                    clicked => {
                        root.import_csv();
                        root.show-file-menu = false;
                    }
                    
                    Rectangle {
                        background: import-item.has-hover ? Palette.accent-background.darker(0.1) : transparent;
                        border-radius: 2px;
                        
                        HorizontalLayout {
                            padding-left: 12px;
                            spacing: 8px;
                            
                            Text {
                                text: "üì•";
                                vertical-alignment: center;
                            }
                            Text {
                                text: "Import CSV...";
                                vertical-alignment: center;
                                font-size: 13px;
                            }
                        }
                    }
                }
                
                export-item := TouchArea {
                    height: 32px;
                    clicked => {
                        root.export_csv();
                        root.show-file-menu = false;
                    }
                    
                    Rectangle {
                        background: export-item.has-hover ? Palette.accent-background.darker(0.1) : transparent;
                        border-radius: 2px;
                        
                        HorizontalLayout {
                            padding-left: 12px;
                            spacing: 8px;
                            
                            Text {
                                text: "üì§";
                                vertical-alignment: center;
                            }
                            Text {
                                text: "Export CSV...";
                                vertical-alignment: center;
                                font-size: 13px;
                            }
                        }
                    }
                }
            }
        }
        
        // Help Menu Dropdown
        if root.show-help-menu: Rectangle {
            x: 58px;
            y: 32px;
            width: 150px;
            z: 100;
            background: Palette.background;
            border-radius: 4px;
            drop-shadow-blur: 8px;
            drop-shadow-color: #00000040;
            
            VerticalLayout {
                padding: 4px;
                spacing: 2px;
                
                about-item := TouchArea {
                    height: 32px;
                    clicked => {
                        root.show-help-menu = false;
                        service-view.show-about = true;
                    }
                    
                    Rectangle {
                        background: about-item.has-hover ? Palette.accent-background.darker(0.1) : transparent;
                        border-radius: 2px;
                        
                        HorizontalLayout {
                            padding-left: 12px;
                            spacing: 8px;
                            
                            Text {
                                text: "‚ÑπÔ∏è";
                                vertical-alignment: center;
                            }
                            Text {
                                text: "About";
                                vertical-alignment: center;
                                font-size: 13px;
                            }
                        }
                    }
                }
            }
        }
    }
}